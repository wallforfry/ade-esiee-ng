version: '3'
services:
  ade-parser:
    image: 149.202.61.252:6000/ade-parser
    build:
      context: ./ade-parser
      dockerfile: Dockerfile

    volumes:
      - data:/usr/src/app/data

  api:
    image: 149.202.61.252:6000/api
    build:
      context: ./api
      dockerfile: Dockerfile

    volumes:
      - data:/usr/src/app/data

    expose:
      - 5000
    depends_on:
      - ade-parser
    deploy:
      labels:
        - "traefik.port=5000"
        - "traefik.backend=api"
        - "traefik.frontend.rule=Path:/"

  traefik:
    image: traefik:latest
    ports:
      - 5000:80
      - 8080:8080
    networks:
      - traefik-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    configs:
      - source: traefik-config
        target: /etc/traefik/traefik.toml
    deploy:
      placement:
        constraints:
          - node.role == manager

configs:
  traefik-config:
    file: ./traefik/config.toml

volumes:
  data:
